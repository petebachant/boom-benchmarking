# This script was automatically generated by Calkit

import calkit


# Insert all the ZTF alerts
import glob
import fastavro
from tqdm.auto import tqdm

ztf_avro_fpaths = glob.glob("data/ztf_public_20250614/*.avro")

print(f"Found {len(ztf_avro_fpaths)} ZTF alerts")

print("Converting to rows for insertion into PostgreSQL")
rows = []
for alert_avro_fpath in tqdm(ztf_avro_fpaths):
    with open(alert_avro_fpath, "rb") as f:
        reader = fastavro.reader(f)
        for alert in reader:
            alert_fmt = {
                "object_id": alert["objectId"],
                "survey_id": 0,
                "cand_id": alert["candid"],
                "candidate": alert["candidate"],
                "ra": alert["candidate"]["ra"],
                "dec": alert["candidate"]["dec"],
            }
            rows.append(alert_fmt)
# This line left blank so we don't try to print the line above
calkit.save_notebook_stage_out(rows, stage_name='ztf-avro-to-pg-rows', out_name='rows')
